#!/bin/sh
set -eu

echo "[+] Fixing APT repos for Debian Jessie (EOL) on Armbian/Volumio..."

# 
cat > /etc/apt/sources.list <<'EOF'
deb [trusted=yes] http://archive.debian.org/debian/ jessie main contrib non-free
deb [trusted=yes] http://archive.debian.org/debian-security/ jessie/updates main contrib non-free
EOF

# 
#    
if [ -d /etc/apt/sources.list.d ]; then
  for f in /etc/apt/sources.list.d/*.list; do
    [ -f "$f" ] || continue
    sed -i 's/^[[:space:]]*deb[[:space:]]\+http:\/\/www\.lesbonscomptes\.com\/.*/# &/g' "$f"
    sed -i 's/^[[:space:]]*deb-src[[:space:]]\+http:\/\/www\.lesbonscomptes\.com\/.*/# &/g' "$f"
  done
fi

# 2
cat > /etc/apt/apt.conf.d/99insecure-jessie <<'EOF'
Acquire::Check-Valid-Until "false";
Acquire::AllowInsecureRepositories "true";
Acquire::AllowDowngradeToInsecureRepositories "true";
APT::Get::AllowUnauthenticated "true";
EOF

# 
apt-get update || {
  echo "[!] apt-get update failed"
  exit 1
}

echo "[+] Done. You can run: apt-get upgrade"
exit 0
